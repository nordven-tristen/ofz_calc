# ofz_calc

Набор утилит и веб‑приложение для расчёта и планирования инвестиций в ОФЗ с фиксированным купоном.

## Структура файлов

- **`app.py`** — веб‑интерфейс (Streamlit)
  - **Что делает**: предоставляет удобный графический интерфейс для двух задач:
    - расчёт доходности ОФЗ с реинвестированием купонов (по заданным SECID, дате покупки и количеству);
    - обратная задача — подбор количества бумаг под целевую сумму к погашению.
  - **Вход**:
    - HTTP‑запросы пользователя через браузер;
    - значения, введённые в формы Streamlit (SECID, даты, количество, целевая сумма, флаги реинвестирования);
    - опционально локальный кэш `ofz_cache.json`.
  - **Выход**:
    - HTML‑страницы с виджетами Streamlit, показателями (`metric`), текстовым логом реинвестирования;
    - при нажатии на кнопку обновления кэша — файл `ofz_cache.json`.

- **`ofz_core.py`** — ядро расчётов по ОФЗ
  - **Что делает**:
    - получает данные по ОФЗ из MOEX ISS API (цена, НКД, номинал, дата погашения, график купонов);
    - моделирует реинвестирование купонов в целые облигации (подробная и упрощённая версии);
    - решает обратную задачу: подбор минимального количества бумаг под целевую сумму к погашению;
    - реализует простой JSON‑кэш данных облигаций.
  - **Вход (функции)**:
    - `fetch_bond(secid)` — строковый SECID;
    - `simulate_reinvest_*` — словарь с данными облигации, дата покупки, количество, цена реинвеста, флаг переноса остатков;
    - `find_min_qty_for_target` — данные облигации, дата покупки и целевая сумма;
    - `download_fixed_ofz_cache` / `get_bond_cached` / `save_cache` / `load_cache` — путь к кэшу (`Path`) и/или словари с bond‑ами.
  - **Выход (функции)**:
    - словари с рассчитанными суммами, доходностью, количеством бумаг и логом шагов реинвестирования;
    - JSON‑файл кэша `ofz_cache.json` с данными по множеству ОФЗ.

- **`ofz_parser.py`** — парсер таблицы ОФЗ с сайта Smart‑Lab
  - **Что делает**:
    - скачивает HTML‑страницу Smart‑Lab с котировками ОФЗ;
    - парсит основную таблицу (имя, погашение, доходность, цена, купон, частота выплат);
    - по имени бумаги подбирает SECID через MOEX ISS (борды TQOB/TQCB);
    - сохраняет сгруженный набор данных в JSON‑кэш.
  - **Вход**:
    - сетевой доступ к `smart-lab.ru` и MOEX ISS;
    - при запуске `python ofz_parser.py` — ответы пользователя на вопросы в консоли (обновлять ли кэш, лимит строк для вывода).
  - **Выход**:
    - файл `ofz_cache_parsed.json` с полным списком облигаций и их параметров;
    - опционально табличный вывод основных колонок в stdout.

- **`ofz_income_planner.py`** — подбор ОФЗ под желаемый годовой купонный доход
  - **Что делает**:
    - загружает данные из `ofz_cache_parsed.json`;
    - по заданному целевому годовому купонному доходу и количеству лет подбирает выпуск ОФЗ, обеспечивающий этот доход с минимальными начальными затратами;
    - загружает из MOEX ISS детальный график будущих купонов и показывает его.
  - **Вход** (при запуске `python ofz_income_planner.py`):
    - существующий кэш `ofz_cache_parsed.json`;
    - ответы пользователя в консоли: желаемый годовой доход (в рублях) и горизонт в годах (можно дробный).
  - **Выход**:
    - текстовый отчёт в stdout: выбранный выпуск, SECID, сроки, купон, необходимое количество бумаг и объём вложений;
    - список будущих купонных выплат (дата, сумма, валюта) на одну облигацию и на весь объём.

- **`ofz_curs.py`** — консольный калькулятор доходности ОФЗ с реинвестированием
  - **Что делает**:
    - берёт данные по одной ОФЗ из MOEX ISS API через `ofz_core.fetch_bond`;
    - считает купоны до погашения и реинвестирует их в целые облигации по номиналу;
    - выводит итоговую сумму к погашению, прибыль и среднегодовую доходность, а также подробный лог шагов.
  - **Вход** (при запуске `python ofz_curs.py`):
    - интерактивный ввод в консоли: SECID, дата покупки, первоначальное количество бумаг, флаг переноса остатка купонов.
  - **Выход**:
    - текст в stdout: исходные параметры, промежуточный лог реинвестирования и итоговые метрики.

- **`ofz_target.py`** — обратная задача по целевой сумме к погашению
  - **Что делает**:
    - по данным MOEX ISS API и модели из `ofz_core` подбирает минимальное целое количество ОФЗ, которое при реинвестировании купонов обеспечит целевую сумму к погашению;
    - выводит требуемое количество бумаг и ориентировочные затраты на покупку.
  - **Вход** (при запуске `python ofz_target.py`):
    - интерактивный ввод в консоли: SECID, дата покупки, целевая сумма к погашению (в рублях).
  - **Выход**:
    - текст в stdout: дата погашения, необходимое количество бумаг, сумма покупки с НКД и ожидаемая сумма к погашению.

- **`ofz_cache.json`** — кэш котировок ОФЗ с фиксированным купоном (MOEX ISS)
  - **Что делает**: хранит результаты массовой загрузки выпусков ОФЗ с фиксированным купоном из MOEX ISS API (используется веб‑приложением и утилитами, которые работают через `ofz_core`).
  - **Вход**: создаётся и обновляется функциями `download_fixed_ofz_cache` / `save_cache` из `ofz_core`.
  - **Выход**: JSON‑структура вида `{ "updated_at": ..., "items": { SECID: { ...данные облигации... } } }`.

- **`ofz_cache_parsed.json`** — кэш, распарсенный с сайта Smart‑Lab
  - **Что делает**: содержит список облигаций с полями из таблицы Smart‑Lab (имя, срок до погашения, доходность, цена, размер купона, частота выплат, SECID).
  - **Вход**: формируется и перезаписывается скриптом `ofz_parser.py`.
  - **Выход**: служит источником данных для `ofz_income_planner.py` (и любых других утилит, которым нужен полный список выпусков).

- **`requirements.txt`** — зависимости проекта
  - **Что делает**: перечисляет внешние Python‑библиотеки (Streamlit, requests, BeautifulSoup и др.), необходимые для работы всех скриптов и веб‑приложения.
  - **Вход**: используется пакетным менеджером (например, `pip install -r requirements.txt`).
  - **Выход**: установленное окружение Python с нужными пакетами.
